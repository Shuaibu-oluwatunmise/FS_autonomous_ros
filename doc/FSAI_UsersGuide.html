<!DOCTYPE html>
<html>
<head>
<title>FSAI_UsersGuide.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<p><img src="images/IPG_Logo.png" alt="IPG Logo"></p>
<h1 id="cmrosif-users-guide-for-fs-autonomous">CMRosIF User's Guide for FS Autonomous</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#cmrosif-user-s-guide-for-fs-autonomous">CMRosIF User's Guide for FS Autonomous</a>
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-introduction">1. <strong>Introduction</strong></a>
<ul>
<li><a href="#11-installation-requirements">1.1 <strong>Installation Requirements</strong></a></li>
</ul>
</li>
<li><a href="#2-whats-included">2. <strong>What's included?</strong></a></li>
<li><a href="#3-quick-start-guide">3. <strong>Quick Start Guide</strong></a></li>
<li><a href="#31-ros-installation--setup">3.1. <strong>ROS Installation &amp; Setup</strong></a></li>
<li><a href="#32-ros2-quick-start">3.2. <strong>ROS2 Quick Start</strong></a></li>
<li><a href="#4-how-can-i-modify-cmrosif">4. <strong>How can I modify CMRosIF?</strong></a>
<ul>
<li><a href="#41-cmnode-in-ros2">4.1. <strong>CMNode in ROS2</strong></a></li>
<li><a href="#42-publishing-carmaker-data-to-ros">4.2. <strong>Publishing CarMaker Data to ROS</strong></a></li>
<li><a href="#43-subscribing-to-ros-data-in-carmaker">4.3. <strong>Subscribing to ROS Data in CarMaker</strong></a></li>
</ul>
</li>
<li><a href="#5-miscellaneous">5. <strong>Miscellaneous</strong></a>
<ul>
<li><a href="#51-lidar-sensor-specifics">5.1 Lidar Sensor Specifics</a></li>
</ul>
</li>
<li><a href="#6-known-limitations">6. <strong>Known Limitations</strong></a>
<ul>
<li><a href="#61-single-camera-per-computation-cluster">6.1 Single Camera per Computation Cluster</a></li>
<li><a href="#62-rsds-node-shutdown-output">6.2 RSDS Node Shutdown Output</a></li>
<li><a href="#63-compilation-errors-with-libcmcppifloader-linux64">6.3 Compilation errors with libcmcppifloader-linux64</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><small><i><a href='http://ecotrust-canada.github.io/markdown-toc/'>Table of contents generated with markdown-toc</a></i></small></p>
<hr>
<h2 id="1-introduction">1. <strong>Introduction</strong></h2>
<p>This project provides an example implementation of CarMaker with ROS (CMRosIF), which has been extended from the standard 'hellocm' example on the IPG Website (FAQ section).</p>
<h3 id="11-installation-requirements">1.1 <strong>Installation Requirements</strong></h3>
<ul>
<li>
<p>Linux Ubuntu 22.04</p>
<ul>
<li><em>Ubuntu 22.04 is the latest version officially supported by CarMaker 14.</em></li>
</ul>
</li>
<li>
<p>ROS2 Humble Hawksbill</p>
<ul>
<li><em>Project was developed using ROS2 Humble, but any ROS2 compatible with Ubuntu 22.04 may work.</em></li>
</ul>
</li>
<li>
<p>CarMaker Office (Linux) 14.1.1</p>
<ul>
<li>
<p>See CarMaker Release Notes and Installation Guide for proper installation procedure.</p>
</li>
<li>
<p>Ensure the following step is taken (excerpt from CarMaker Installation Guide):</p>
</li>
</ul>
<p><img src="images/CM_Linux_Install.png" alt="CM Install Shortcut"></p>
</li>
</ul>
<hr>
<h2 id="2-whats-included">2. <strong>What's included?</strong></h2>
<ul>
<li>Representative Vehicle Model
<ul>
<li>Vehicle Data for FS-AI ADS-DV
<ul>
<li>Electric Powertrain</li>
<li>Suspension, geometry, and mass data</li>
<li>Some data approximations made, to be improved in future updates.</li>
</ul>
</li>
<li>Sensors:
<ul>
<li>Front Camera Sensor
<ul>
<li>Raw Video Data Streams via <strong>Camera RSI Sensor</strong>
<ul>
<li>RGB Output</li>
<li>Depth Output</li>
</ul>
</li>
<li>'High Fidelity' Camera Model via <strong>Camera HiFi Sensor</strong></li>
<li>Ground Truth Object List via <strong>Object Sensor</strong></li>
</ul>
</li>
<li>Front Lidar Sensor via <strong>Lidar RSI Sensor</strong></li>
<li>Sensor data is published to ROS over separate topics:
<ul>
<li>pointcloud</li>
<li>Camera</li>
<li>ObjectList</li>
</ul>
</li>
</ul>
</li>
<li>Vehicle Control Interface
<ul>
<li>Allows user to send ROS commands to CarMaker and control the vehicle.</li>
</ul>
</li>
</ul>
</li>
<li>Example Track Drive TestRun</li>
<li>Cone Placement Script
<ul>
<li>Automatic placement of FS-AI cones around a given track.</li>
<li>Script usage guide and basic documentation.</li>
</ul>
</li>
<li>Detailed code documentation of the CMJob Scheduler functionality and components</li>
</ul>
<hr>
<h2 id="3-quick-start-guide">3. <strong>Quick Start Guide</strong></h2>
<h2 id="31-ros-installation--setup">3.1. <strong>ROS Installation &amp; Setup</strong></h2>
<p>The process for installing ROS2 is outlined in the respective ROS wiki page. For convenience the steps and some suggestions are available here as well:</p>
<ol>
<li>For ROS2 the page is version-specific, e.g.: https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html</li>
<li>For ROS2, it is critical to also install Colcon in order to build the packages. The documentation is once again version-specific, e.g. https://docs.ros.org/en/humble/Tutorials/Beginner-Client-Libraries/Colcon-Tutorial.html#install-colcon</li>
</ol>
<p>It is highly recommended to setup a symbolic link for the currently preferred ROS2 installation to the respectively named folder. That makes switching between versions much easier in the future with respect to the build process of the CarMaker package.</p>
<p>The default installation folder for ROS is <code>/opt/ros</code>, and the recommended folder that CarMaker queries by default is <code>/opt/ros/ros2</code> for ROS2. Thus the symbolic links would look like:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">cd</span> /opt/ros 
sudo ln -sfn humble ros2
</div></code></pre>
<p>These are of course version-specific. The versions named here are the ones with which the package was officially tested and validated.</p>
<h2 id="32-ros2-quick-start">3.2. <strong>ROS2 Quick Start</strong></h2>
<ol>
<li>Run the build script <code>build.sh</code> in a terminal (located on the top level of the project). This will build the ROS workspace (located in <code>&lt;project&gt;/ros/ros2_ws</code>), then the CarMaker application (located in <code>&lt;project&gt;/src</code>).</li>
<li>Open CarMaker with the <code>CMStart.sh</code> script on the top level of the project.
<ul>
<li>You might see a warning when running CMStart.sh about the <em>FS_autonomous_TrackDrive road file (&quot;Reading road definition failed&quot;)</em>. This doesn't affect functionality.</li>
</ul>
</li>
<li>Start the ROS workspace and CarMaker application from: <code>Main CarMaker GUI --&gt; Extras --&gt; CMRosIF --&gt; Launch &amp; Start Application</code>. This will launch the ROS workspace from the <code>hellocm.launch</code> file, then Start and connect to the CarMaker application.</li>
<li>Open the example 'TrackDrive' TestRun from the <code>Main GUI --&gt; File --&gt; Open --&gt; Project --&gt; FS_autonomous_TrackDrive</code>.
<ul>
<li><strong>Update Simulation Parameter for Camera RSI Compatibility (CarMaker 14+)</strong>
From CarMaker 14 onwards, the MovieNX engine introduces a warmup phase for GPU-based RSI sensors.
To avoid timeout errors when using multiple Camera RSI sensors, especially RGB + Depth streams simultaneously, add the following simulation parameter:
<code>SimStart.Anim.Wait = 300</code>
You can either include the parameter from <code>CM GUI -&gt; Application -&gt; Edit 'SImParameters'</code> or you can find the SimParameters file from your <code>project folder/Data/Config</code>
This ensures RSI sensors have enough startup time to avoid timeout issues (ERROR GPUSensor A3:192.168...: Timeout) observed in some configurations on systems with limited GPU VRAM.</li>
</ul>
</li>
<li>Start the simulation with the green Start button in the CarMaker GUI. ROS data should be published and subscribed to by CMRosIF from the following topics. The main topics in this extension to CMRosIF are <strong>/Camera</strong>, <strong>/ObjectList</strong>, <strong>/pointcloud</strong>, and <strong>/VehicleControl</strong>.</li>
</ol>
<pre class="hljs"><code><div>    foo@bar:~$ <span class="hljs-built_in">source</span> ./ros/ros2_ws/install/setup.bash; ros2 topic list
      /carmaker/Camera
      /carmaker/ObjectList
      /carmaker/VehicleControl
      /carmaker/cm2ext
      /carmaker/parameter_events
      /carmaker/pointcloud
      /carmaker/rosout
      /clock
      /front_camera_depth/camera_info
      /front_camera_depth/image_raw
      /front_camera_depth/parameter_events
      /front_camera_depth/rosout
      /front_camera_rgb/camera_info
      /front_camera_rgb/image_raw
      /front_camera_rgb/parameter_events
      /front_camera_rgb/rosout
      /hellocm/ext2cm
      /hellocm/parameter_events
      /hellocm/rosout
      /parameter_events
      /rosout
      /tf
      /tf_static
</div></code></pre>
<p>At this stage, the simulation is active and running. If you publish a <strong>/VehicleControl</strong> ROS message on the ROS2 network, the vehicle should move. This message is described in more detail in the example in <a href="#43-subscribing-to-ros-data-in-carmaker">Section 4.3</a>.</p>
<p><img src="images/QuickStart_Simulation_rVizMovie.png" alt="Simulation Visualization in rViz + IPGMovie">
6. If raw camera streams are desired, multiple CameraRSI sensors can be defined and mounted on the CarMaker vehicle frame. Currently these cameras can be either RGB (<code>Coloration mode: Realistic</code>) or Depth (<code>Coloration mode: Depth linear gray</code>). Every active camera will automaticall launch a separate external Raw Signal Data Stream client (ROS node) that recieves the raw data from the Camera RSI Sensors (aka Raw Signal Data Stream) in CarMaker, then publishes it to standard ROS image messages in the topics <strong>/&lt;CAMERA_NAME&gt;</strong>.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 756</span>
<span class="hljs-comment">/* Do a system call to ros2 launch and launch the ROS node */</span>
<span class="hljs-built_in">sprintf</span>(sbuf, <span class="hljs-string">"ros2 launch carmaker_rsds_client carmaker_rsds_client.launch.py \
camera_no:=%d \
camera_name:=%s \
rsds_port:=%d \
param_trans_rot:=[%f,%f,%f,%f,%f,%f] \
fov_deg:=%f \
width:=%f \
height:=%f &amp;"</span>,
Camera.number,
Camera.name,
Camera.Socket,
Camera.pos[<span class="hljs-number">0</span>],Camera.pos[<span class="hljs-number">1</span>],Camera.pos[<span class="hljs-number">2</span>],Camera.rot[<span class="hljs-number">0</span>],Camera.rot[<span class="hljs-number">1</span>],Camera.rot[<span class="hljs-number">2</span>],
Camera.FoV,
Camera.Resolution[<span class="hljs-number">0</span>],
Camera.Resolution[<span class="hljs-number">1</span>]);
system(sbuf);
</div></code></pre>
<p><img src="images/RSDS_Streams_RQT.png" alt="Raw Signal Data Stream Client Start"></p>
<p>For more information and troubleshooting on the RSDS ROS client nodes, see the corresponding README file in <code>&lt;project&gt;/ros/ros2_ws/src/carmaker_rsds_client</code>.</p>
<h2 id="33-troubleshooting-common-setup-issues">3.3. Troubleshooting Common Setup Issues</h2>
<p>If you encounter issues during installation or when launching the project, please check the following notes collected from common user feedback.</p>
<h3 id="331-build-script-permission-denied">3.3.1 Build script permission denied</h3>
<p>If running <code>./build.sh</code> gives <strong>Permission denied</strong>, the build script is missing execute permission.
Run the following commands once:</p>
<pre class="hljs"><code><div>chmod +x build.sh ros/ros2_ws/build.sh
</div></code></pre>
<p>Then try again</p>
<pre class="hljs"><code><div>./build.sh
</div></code></pre>
<h3 id="332-%22colcon-command-not-found%22">3.3.2 &quot;colcon: command not found&quot;</h3>
<p><code>colcon</code> is required to build ROS2 packages as stated in Section 3.1. Install it with:</p>
<pre class="hljs"><code><div>sudo apt update
sudo apt install python3-colcon-common-extensions
</div></code></pre>
<h3 id="333-cmstartsh-%22cmoffice-1411-command-not-found%22">3.3.3 CMStart.sh: &quot;CM_Office-14.1.1: command not found&quot;</h3>
<p>CarMaker 14.1.1 normally installs a symbolic link at <code>/opt/ipg/bin/CM_Office-14.1.1</code> that points to the actual binary <code>/opt/ipg/carmaker/linux64-14.1.1/bin/CM_Office</code>.
If that link is missing, create it with:</p>
<pre class="hljs"><code><div>sudo ln -s /opt/ipg/carmaker/linux64-14.1.1/bin/CM_Office /opt/ipg/bin/CM_Office-14.1.1
</div></code></pre>
<p>To make sure the command is always found, add the following lines to your <code>~/.bashrc</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># CarMaker 14.1.1 environment</span>
<span class="hljs-built_in">export</span> CM_HOME=/opt/ipg/carmaker/linux64-14.1.1
<span class="hljs-built_in">export</span> CARMAKER_BASE=/opt/ipg/carmaker
<span class="hljs-built_in">export</span> CARMAKER_VER=14.1.1
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"/opt/ipg/bin:<span class="hljs-variable">$CM_HOME</span>/bin:<span class="hljs-variable">$PATH</span>"</span>
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-string">"<span class="hljs-variable">$CM_HOME</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span>"</span>
<span class="hljs-built_in">export</span> ROS_VERSION=2

<span class="hljs-comment"># ROS2 Humble</span>
<span class="hljs-built_in">source</span> /opt/ros/humble/setup.bash
</div></code></pre>
<hr>
<h2 id="4-how-can-i-modify-cmrosif">4. <strong>How can I modify CMRosIF?</strong></h2>
<h3 id="41-cmnode-in-ros2">4.1. <strong>CMNode in ROS2</strong></h3>
<p>The CarMaker ROS Interface is meant to be modified by the user to publish and subscribe to data they need in ROS and CarMaker.</p>
<p>Most code changes in this example project are made in the following files:</p>
<pre class="hljs"><code><div>&lt;project&gt;/ros/ros2_ws/src/hellocm_cmnode/src/CMNode_ROS2_HelloCM.cpp
&lt;project&gt;/ros/ros2_ws/src/hellocm_cmnode/src/CMNode_ROS2_HelloCM.hpp
</div></code></pre>
<p>These files are the source code for the <em>internal</em> node in CMRosIF used to communicate with all external ROS nodes via topics, services, etc. This node can be thought of as the port in and out of CarMaker. The standard example only publishes 'hello' messages back and forth between the <code>CMNode</code> and an example external node, along with simulation clock and an initialization topic to start the co-simulation with ROS.</p>
<h3 id="42-publishing-carmaker-data-to-ros">4.2. <strong>Publishing CarMaker Data to ROS</strong></h3>
<p>In general, the process used to publish CarMaker data in ROS topics takes the following modifications (mostly in <em>CMNode_ROS2_HelloCM.cpp</em>):</p>
<ol>
<li>
<p>Include necessary header files for CarMaker quantities and ROS message definitions at the beginning of the <em>CMNode_ROS2_HelloCM.hpp</em> file.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 15</span>
<span class="hljs-comment">/* CarMaker
* - include other headers e.g. to access to vehicle data
*   - e.g. "Vehicle.h" or "Vehicle/Sensor_*.h".
* - additional headers can be found in "&lt;CMInstallDir&gt;/include/"
* - see Reference Manual, chapter "User Accessible Quantities" to find some variables
*   that are already defined in DataDictionary and their corresponding C-Code Name
*/</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Log.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"DataDict.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimCore.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"InfoUtils.h"</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"apo.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"GuiCmd.h"</span></span>

<span class="hljs-comment">//CarMaker Header File Includes</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Vehicle.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Vehicle/Sensor_LidarRSI.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Vehicle/Sensor_Object.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Vehicle/Sensor_Camera.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"infoc.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Car/Car.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Car/Brake.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"DrivMan.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"VehicleControl.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Traffic.h"</span></span>

<span class="hljs-comment">/* ROS */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"cmrosutils/cmrosif.hpp"</span>                   <span class="hljs-comment">/* Only for CarMaker ROS Node!!! Functions are located in library for CarMaker ROS Interface */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"cmrosutils/srv/cm_remote_control.hpp"</span>     <span class="hljs-comment">/* Basic service for CarMaker remote from ROS */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"sensor_msgs/msg/point_cloud.hpp"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"visualization_msgs/msg/marker_array.hpp"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"tf2_geometry_msgs/tf2_geometry_msgs.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"tf2_ros/transform_broadcaster.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"tf2_ros/static_transform_broadcaster.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;angles/angles.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"vehiclecontrol_msgs/msg/vehicle_control.hpp"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"camera_msgs/msg/camera_detection_array.hpp"</span></span>
</div></code></pre>
</li>
<li>
<p>Create a CMJob publisher in <code>CMNodeHelloCM::userTestrunStartAtBegin()</code> and add it to the scheduler. The Doxygen documentation <strong>CMJobScheduler.html</strong> supplied with this project contains a full list of available methods for the RosPublisher class.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 497</span>
{ <span class="hljs-comment">/* set up cm2ext publisher + job */</span>
  <span class="hljs-keyword">typedef</span> CMJob::RosPublisher&lt;hellocm_msgs::msg::CM2Ext&gt; <span class="hljs-keyword">cm2ext_t</span>;
  <span class="hljs-keyword">auto</span> job = <span class="hljs-built_in">std</span>::make_shared&lt;<span class="hljs-keyword">cm2ext_t</span>&gt;(nhp_, <span class="hljs-string">"cm2ext"</span>);
  job-&gt;setCycleTime(<span class="hljs-number">15000</span>);
  job-&gt;registerCallback(&amp;CMNodeHelloCM::cm2extFillMsg, <span class="hljs-keyword">this</span>);
  scheduler_.addJob(job);
}
</div></code></pre>
</li>
<li>
<p>Create a callback for each published topic. The publisher callback fills the message to be piblished with desired data to be transmitted over ROS. Don't forget to declare callbacks in <em>CMNode_ROS2_HelloCM.hpp</em> as well.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 432</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CMNodeHelloCM::cm2extFillMsg</span><span class="hljs-params">(hellocm_msgs::msg::CM2Ext&amp; msg)</span> </span>{
  msg.cycleno = <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">uint32_t</span>&gt;(rel_cycle_num_);
  msg.time = rclcpp::Time(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">int64_t</span>&gt;(<span class="hljs-number">1e9</span> * SimCore.Time), RCL_ROS_TIME);
  msg.synthdelay = synth_delay_;
  msg.header.stamp = rclcpp::Clock().now();
}
</div></code></pre>
</li>
<li>
<p>Delete all jobs in <code>userTestrunEnd()</code>, otherwise restarting the simulation will attempt to create a duplicate of an existing job.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 840</span>
scheduler_.deleteJob(<span class="hljs-string">"cm2ext"</span>);
</div></code></pre>
</li>
</ol>
<p>The CMRosIF 'Job' functions used are not required, but they help with error handling and cyclical publishing, so that data packaging and publishing doesn't need to be done every simulation cycle. This would cause potentially unnecessarily high publishing rates that reduce simulation efficiency.</p>
<h3 id="43-subscribing-to-ros-data-in-carmaker">4.3. <strong>Subscribing to ROS Data in CarMaker</strong></h3>
<ol>
<li>
<p>Include necessary header files for CarMaker quantities and ROS message definitions at the beginning of the <em>CMNode_ROS2_HelloCM.hpp</em> file (see previous code snippets).</p>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"VehicleControl.h"</span></span>
...
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"vehiclecontrol_msgs/VehicleControl_msgs.h"</span></span>
</div></code></pre>
</li>
<li>
<p>Create a CMJob subscriber in <code>CMNodeHelloCM::userTestrunStartAtBegin()</code> and add it to the scheduler. The Doxygen documentation <strong>CMJobScheduler.html</strong> supplied with this project contains a full list of available methods for the RosSubscriber class.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~line 778</span>
{ <span class="hljs-comment">/* set up VehicleControl subscriber + job */</span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> topic = <span class="hljs-string">"VehicleControl"</span>;
  <span class="hljs-keyword">bool</span> synchronize = (sync_mode_ == SyncMode::kTopic);
  CMJob::JobType job_type =
      synchronize ? CMJob::JobType::Cyclic : CMJob::JobType::Trigger;

  <span class="hljs-keyword">typedef</span> CMJob::RosSubscriber&lt;vehiclecontrol_msgs::msg::VehicleControl&gt; VC;
  <span class="hljs-keyword">auto</span> job = <span class="hljs-built_in">std</span>::make_shared&lt;VC&gt;(job_type, synchronize, nhp_, topic);
  job-&gt;setCycleTime(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>&gt;(<span class="hljs-number">1</span>));
  job-&gt;skipFirstCycles(<span class="hljs-number">1</span>);
  job-&gt;registerCallback(&amp;CMNodeHelloCM::vehicleControlCallback, <span class="hljs-keyword">this</span>);
  scheduler_.addJob(job);
} <span class="hljs-comment">// set up VehicleControl subscriber + job</span>
</div></code></pre>
</li>
<li>
<p>Create a callback for each subscribed topic. The subscriber callback receives messages over ROS and processes their data. Don't forget to declare callbacks in <em>CMNode_ROS2_HelloCM.hpp</em> as well.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 163</span>
<span class="hljs-comment">/* Vehicle Control Subscriber Callback */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CMNodeHelloCM::vehicleControlCallback</span><span class="hljs-params">(vehiclecontrol_msgs::msg::VehicleControl::ConstSharedPtr msg)</span> </span>{

  CMNode.VC.use_vc          = msg-&gt;use_vc;
  CMNode.VC.selector_ctrl   = msg-&gt;selector_ctrl;
  CMNode.VC.gas             = msg-&gt;gas;
  CMNode.VC.brake           = msg-&gt;brake;
  CMNode.VC.steer_ang       = msg-&gt;steer_ang;
  CMNode.VC.steer_ang_vel   = msg-&gt;steer_ang_vel;
  CMNode.VC.steer_ang_acc   = msg-&gt;steer_ang_acc;
}
</div></code></pre>
<p>In the case of the Vehicle Control interface, a custom ROS message is used (see the package <code>vehiclecontrol_msgs</code> for more info. This message requires the user to set the flag '<strong>use_vc</strong>' in order to write to CarMaker vehicle control quantities. When the user wants to take over control of the vehicle, this boolean must be written to <em>1 (True)</em>, or else Vehicle Control quantities cannot be written to. In the reverse scenario, when the user wants to stop writing to Vehicle Control quantities and maybe return control to IPGDriver, set this '<strong>use_vc</strong>' flag to <em>0 (False)</em>.</p>
</li>
<li>
<p>Delete all jobs in <code>userTestrunEnd()</code>, otherwise restarting the simulation will attempt to create a duplicate of an existing job.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 838</span>
scheduler_.deleteJob(<span class="hljs-string">"VehicleControl"</span>);
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="5-miscellaneous">5. <strong>Miscellaneous</strong></h2>
<h3 id="51-lidar-sensor-specifics">5.1 Lidar Sensor Specifics</h3>
<p>There are a few things to note about the Lidar RSI sensor and how its data is being published to the ROS <code>pointcloud</code> topic. The PointCloud1 message type is used, and may be updated to PointCloud2 in the future.</p>
<p>Compared to other sensor data, the Lidar RSI sensor needs its <em>beam table</em> to be looped over so that each outgoing laser beam in the map can be linked to a horizontal and vertical angle. From these angles and the lidar's length or time of flight, a point cloud can be constructed and packed into the pointcloud message type (see CMRosIF_CMNode_Calc() function for pointcloud packaging code).</p>
<p>The example code relies on a variable called tableSize, which is defined globally in <code>CMNode</code>, and needs to be changed when the number of beams changes in the CarMaker sensor. If the number of horizontal or vertical 'beams' in the Lidar RSI sensor changes, this variable needs to be updated (and still multiplied by 6), then the ROS workspace needs to be recompiled via <code>build.sh</code>.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ~Line 38</span>
<span class="hljs-comment">/*
    beams_h * beams_v = tableSize
    Ex: 300 * 50 = 15000
*/</span>
<span class="hljs-comment">//Lidar RSI --&gt; Number of Beams</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> tableSize = <span class="hljs-number">15000</span> * <span class="hljs-number">6</span>;
</div></code></pre>
<p><img src="images/Lidar_Beams.png" alt="Lidar Beams Calc"></p>
<p>The solution is not the very elegant, and is planned to be updated in the future so that code recompilation is not necessary when the number of beams is changed.</p>
<h2 id="6-known-limitations">6. <strong>Known Limitations</strong></h2>
<h3 id="61-single-camera-per-computation-cluster">6.1 Single Camera per Computation Cluster</h3>
<p>In CarMaker, RSI sensors of the same type can be grouped together in a computational cluster. A cluster executes on the GPU as one unit with the same timing and delay. The Sensor Cluster Configuration window can be accessed through <code>Main GUI --&gt; Parameters --&gt; Sensor Cluster</code>.</p>
<p>The current implementation of the RSDS node in ROS can only handle one camera per cluster. If a cluster has two or more cameras, only one will properly transmit data over ROS, and it may not be the one originally intended for the RSDS node. Please put only once CameraRSI per cluster.</p>
<p><img src="images/Sensor_Cluster_Configuration.png" alt="Sensor Cluster Configuration"></p>
<h3 id="62-rsds-node-shutdown-output">6.2 RSDS Node Shutdown Output</h3>
<p>The RSDS ROS nodes need to be launched somewhat dynamically from inside <code>CMNode</code>. The number of active nodes varies per simulation depending on the number of active Camera RSI sensors. All RSDS nodes and their attached RQT Image Viewers should therefore be shutdown at the end of a CarMaker simulation. ROS at present does not offer a graceful shutdown of a node externally. Therefore, it is normal to see errors or feedback at the end of every simulation if any RSDS nodes need to be brought down.</p>
<p>In ROS2, there is no standard terminal command to shutdown any node remotely. The concept of <strong>Managed (Lifecycle)</strong> nodes can be implemented for a node to accept a shutdown request. However, at present, <strong>Managed</strong> nodes do not support the <code>image_transport::CameraPublisher</code> needed to actually transmit images. Since this node focuses on image transmission, it cannot be implemented as a <strong>Lifecycle</strong> node. Instead, the node is brough down with a standard OS <code>pkill</code> command. That will cause the node to shutdown with a standard &quot;process has died&quot; error message in the terminal.</p>
<p><img src="images/RSDS_Shutdown_Error_2.png" alt="RSDS Node Shutdown Error ROS2"></p>
<p>If any of these error messages happen at the end of a simulation, they can be safely ignored.</p>
<h3 id="63-compilation-errors-with-libcmcppifloader-linux64">6.3 Compilation errors with libcmcppifloader-linux64</h3>
<p>On rare occasions, the first time you attempt to build the FSAI ROS project with the <code>build.sh</code> script, it will fail with the following error related to <code>libcmcppifloader-linux64.so</code>:</p>
<pre class="hljs"><code><div>/usr/bin/ld:./../lib//libcmcppifloader-linux64.so: file format not recognized; treating as linker script
/usr/bin/ld:./../lib//libcmcppifloader-linux64.so:0: syntax error
collect2: error: ld returned 1 <span class="hljs-built_in">exit</span> status
make: *** [Makefile:67: CarMaker.linux64] Error 1
</div></code></pre>
<p>The file <code>libcmcppifloader-linux64.so</code> is a symbolic link to the latest version of the actual CMRosIF library, which is currently <code>libcmcppifloader-linux64.so.1.0.0</code> at the time this project is published. When this project is first downloaded, the symbolic link may break for various reasons. It needs to be manually re-created. From the FSAI project directory, you can re-create the link at the proper location with the following terminal commands:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">cd</span> lib
sudo ln -sfn libcmcppifloader-linux64.so.1.0.0 libcmcppifloader-linux64.so
</div></code></pre>

</body>
</html>
